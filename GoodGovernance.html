<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <title>What Makes A Good Government?</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="./captxt.js"></script>
    <style>
    	body {
    		/*background-color: lightcyan;*/
    		font-family: Source Sans Pro, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif;
    		font-weight: 400;
    		margin: 0;
    	}

    	.header {
    		padding: 5px;
    		color: black;
    	}

    	.primary {
    		position: fixed;
    		left: 50%;
    		transform: translateX(-50%);
    		width: 1310px;
    		overflow-y: auto;
    		height: calc(100% - 87px);
    		/*background-color: #FFEBCD;*/
    	}

    	.updown {
    		cursor: pointer;
    	}

    	#grid {
    		position: relative;
    		float: left;
    	}

    	#infobox {
    		position: relative;
    		float: right;
    		height: 810px;
    		width: 200px;
    		/*background-color: #DBB394;*/
    		padding: 5px;
    	}

    	#country {
    		height: 40px;
    	}

    	#value {
    		height: 16px;
    	}

    	#textbox {
    		height: 200px;
    		width: 200px;
    	}

    	.title {
    		font-size: 24px;
    		width: 100%;
    		text-align: center;
    	}

    	.subtitle {
    		font-size: 18px;
    		width: 100%;
    		text-align: center;
    	}

    	.subsubtitle {
    		font-size: 16px;
    		width: 100%;
    		text-align: center;
    	}

    	.topbottom {
    		font-size: 12px;
    	}

    	.changer {
    		display: inline;
    		position: absolute;
    		left: 50%;
    		transform: translateX(-50%);
    	}

    	#param {
    		display: inline-block;
    		max-width: 200px;
    	}

    	.modbg {
    		position: fixed;
    		left: 0;
    		top: 0;
    		height: 100%;
    		width: 100%;
    		background-color: black;
    		opacity: 0.5;
    		z-index: 10;
    	}

    	.modal {
    		position: fixed;
    		left: 50%;
    		top: 10px;
    		transform: translateX(-50%);
    		background-color: lightgrey;
    		height: 600px;
    		width: 900px;
    		opacity: 1.0;
    		z-index: 15;
    		padding: 10px;
    	}

    	.modtxt {
    		font-family: Source Serif Pro, Roboto Slab, Domine, Garamond, Times New Roman, serif;
    		font-weight: 400;
    	}

    	.modpan {
    		width: 290px;
    		padding: 5px;
    		height: 410px;
    		position: relative;
    		float: left;
    		margin: 0;
    	}

    	.modhalf {
    		width: 690px;
    		padding: 3px;
    		margin: 0;
    	}

    	.panttl {
    		font-family: Source Sans Pro, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif;
    		width: 100%;
    		display: inline-block;
    		text-align: center;
    	}

    	.halfttl {
    		font-family: Source Sans Pro, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif;
    	}

    	.modimg {
    		padding: 10px;
    		padding-left: 45px;
    	}

    	.closebtn {
    		position: absolute;
    		right: 5px;
    		bottom: 5px;
    		height: 30px;
    		width: 60px;
    	}

    	.tb3txt {
    		color: blue;
    		cursor: pointer;
    	}
			
			#controlbox {
    		position: relative;
    		float: left;
				z-index: 7;
				width: 200px;
    	}
	</style>
</head>
<body>
	<div class='header'>
		<div class='title'>What Makes a Good Government?</div>
		<div class='subtitle'>A Tool for Exploring 21 Years of the <a href="http://info.worldbank.org/governance/wgi/#home" target="_blank">Worldwide Governance Indicators</a></div>
		<div class="subtitle" id="intro" style="color: blue; cursor:pointer; position:relative; float:right;"><u>INTRODUCTION</u></div>
		<div class="subtitle" id="help" style="color: blue; cursor:pointer; position:relative; float:right;"><u>HELP</u></div><hr/>
	</div>
	<div class='primary'>
		<div id="controlbox" class="">
			<div class='subtitle'><u>Controls</u></div><br/>
			<span class='topbottom'>Year: </span>
			<div class="changer">
			<span class="updown" id="downyear" title="Change Year Down">&#x25C0;</span>
			<select id="year">
				<option selected value="ALL" id="allyear">ALL</option>
				<option value="1996">1996</option>
				<option value="1998">1998</option>
				<option value="2000">2000</option>
				<option value="2002">2002</option>
				<option value="2003">2003</option>
				<option value="2004">2004</option>
				<option value="2005">2005</option>
				<option value="2006">2006</option>
				<option value="2007">2007</option>
				<option value="2008">2008</option>
				<option value="2009">2009</option>
				<option value="2010">2010</option>
				<option value="2011">2011</option>
				<option value="2012">2012</option>
				<option value="2013">2013</option>
				<option value="2014">2014</option>
				<option value="2015">2015</option>
				<option value="2016">2016</option>
				<option value="2017">2017</option>
			</select>
			<span class="updown" id="upyear" title="Change Year Up">&#x25B6;</span></div><br/><br/>
			<span class='topbottom'>Index: </span>
			<div class="changer">
			<span class="updown" id="downparam" title="Change Index Down">&#x25C0;</span>
			<select id="param">
				<!--<option value="ALL" id="allparam" disabled>ALL</option>
				<option value="VA" selected>Voice & Accountability</option>
				<option value="PS">Political Stability & Absence of Violence/Terrorism</option>
				<option value="GE">Government Effectiveness</option>
				<option value="RQ">Regulatory Quality</option>
				<option value="RL">Rule of Law</option>
				<option value="CC">Control of Corruption</option>-->
				<option value="ALL" id="allparam" disabled>ALL</option>
				<option value="VA" selected>VA</option>
				<option value="PS">PS</option>
				<option value="GE">GE</option>
				<option value="RQ">RQ</option>
				<option value="RL">RL</option>
				<option value="CC">CC</option>
			</select>
			<span class="updown" id="upparam" title="Change Index Up">&#x25B6;</span></div><br/><br/>
			<span class='topbottom'>Continent Outlines: </span>
			<select id="showCon">
				<option selected val="Off" title="Hide Continent Outlines">Off</option>
				<option val="On" title="Show Continent Outlines">On</option>
			</select><br/><br/>
			<span class='topbottom'>Source: <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1682130" target="_blank">Kaufmann D., A. Kraay, and M. Mastruzzi (2010), The Worldwide Governance Indicators: Methodology and Analytical Issues</a></span>
		</div>
		<svg id="grid" height=810 width=1080></svg>
		<div id="infobox">
			<svg id="cbar" height=150 width=200></svg>
			<div class="subtitle" id="tbhead"><u>Change <span id="tbrange"></span></u></div><br/>
			<div class='topbottom'><u>Top 3</u></div>
			<span class='topbottom'>1) </span><span class='topbottom' id="t3-1"></span><br/>
			<span class='topbottom'>2) </span><span class='topbottom' id="t3-2"></span><br/>
			<span class='topbottom'>3) </span><span class='topbottom' id="t3-3"></span><br/><br/>
			<div class='topbottom'><u>Bottom 3</u></div>
			<span class='topbottom'>1) </span><span class='topbottom' id="b3-1"></span><br/>
			<span class='topbottom'>2) </span><span class='topbottom' id="b3-2"></span><br/>
			<span class='topbottom'>3) </span><span class='topbottom' id="b3-3"></span><br/>
			<hr/>
			<div class='subtitle'><u>Info Window</u></div><br/>
			<span class='topbottom' style="display:inline-block;"><u id="country"></u></span><br/>
			<span class='topbottom' id="value" style="display:inline-block;"></span>
			<svg id="ctyGraphic" height=200 width=200></svg>
		</div>
	</div>
	<div id="modbg" class="modbg"></div>
	<div id="modal" class="modal">
		<div class="title"><u>WELCOME!</u></div>
		<p class="modtxt">The goal of this interactive visualization is to help ease exploration and comparison of the Worldwide Governance Indicators. These indices have been calculated since 1996 and provide six ways of assessing "good government" across the globe. For more details about the six indices, which are represented as percentiles from 0 to 100, and the methodology, click the link in the title (or <a href="http://info.worldbank.org/governance/wgi/#home" target="_blank">click here</a>) to be taken to the WGI homepage.</p>
		<p class="modtxt modpan"><span class="panttl"><b>ONE INDEX, ONE YEAR</b></span>Each country is represented as a geolocated square. This is to enable easy comparison even between countries with small geographic area. Squares are colored by their index value for the selected year, with more red meaning lower on the 0 to 100 range, and more blue meaning higher. Clicking on a country will display its full name in the "Info Window" as well as its 90th percentile range for value for that index for that year.<img src="./oneone.png" class="modimg"/></p>
		<p class="modtxt modpan"><span class="panttl"><b>ONE INDEX, ALL YEARS</b></span>Each square contains a stripped-down line graph for the 1996-2017 period of the survey. This enables comparison between countries as well as quick assessment of improvements or downgrading over time. Colors here are based on an average value for the index over the time period. Clicking on the country displays a larger version of the line graph in the "Info Window" that includes the 90th percentile uncertainty over time in grey.<img src="./allone.png" class="modimg"/></p>
		<p class="modtxt modpan"><span class="panttl"><b>ALL INDICES, ONE YEAR</b></span>Each square contains a spider chart with each vertex determined by an index value. This enables comparison between countries as well as understanding of strengths or weaknesses among the indices. Colors here are based on an average index value for the year. Clicking on the country displays a larger version of the spider chart in the "Info Window" that includes the 90th percentile uncertainty for the indices in grey as well as vertex labels.<img src="./oneall.png" class="modimg"/></p>
		<p class="modtxt modhalf"><span class="halfttl"><b>ABBREVIATIONS: </b></span><b>VA</b> - Voice & Accountability, <b>PS</b> - Political Stability & Absence of Violence/Terrorism, <b>GE</b> - Government Effectiveness, <b>RQ</b> - Regulatory Quality, <b>RL</b> - Rule of Law, <b>CC</b> - Control of Corruption</p>
		<p class="modtxt modhalf"><span class="halfttl"><b>CONTINENTS: </b></span><span style="color: red;">Africa</span>, <span style="color: orange;">Asia</span>, <span style="color: yellow;">Central America & Caribbean</span>, <span style="color: green;">Europe</span>, <span style="color: blue;">North America</span>, <span style="color: fuchsia;">Oceania</span>, <span style="color: purple;">South America</span></p>
		<button id="close" class="closebtn">CLOSE</button>
	</div>
	<div id="modcap" class="modal" style="height: 200px; width: 500px; display: none;">
		<div class="title"><u id="captitle"></u></div>
		<p class="modtxt" id="captxt"></p>
		<button id="closecap" class="closebtn">CLOSE</button>
	</div>
	<script>
		function palette2(min, max) {
			let d = (max-min)/100
			return d3.scaleThreshold()
			    .range(['#ffc0cb','#fec0cb','#fdc0cb','#fbc0ca','#fbc0ca','#fac0ca','#f8c0ca','#f7c0c9','#f5c0c9','#f4c0c9','#f4c0c9','#f3c0c9','#f1c0c9','#efc0c8','#efc0c8','#edc0c8','#ecc0c8','#ebc0c7','#e9c0c7','#e8c0c7','#e8c0c7','#e6c0c7','#e5c0c6','#e4c0c6','#e3c0c6','#e1c0c6','#e0c0c5','#dfc0c5','#dec0c5','#dcc0c5','#dbc0c4','#d9c0c4','#d8c0c4','#d7c0c4','#d5c0c4','#d5c0c3','#d3c0c3','#d2c0c3','#d0c0c3','#cfc0c2','#cdc0c2','#ccc0c2','#cbc0c2','#c9c0c2','#c8c0c1','#c6c0c1','#c5c0c1','#c4c0c1','#c3c0c0','#c0c0c0','#c0c0c1','#c0c1c1','#bfc2c2','#bfc2c2','#bfc2c4','#bec3c4','#bec4c5','#bec3c5','#bdc4c7','#bdc5c7','#bdc5c8','#bcc6c9','#bcc6ca','#bcc7ca','#bbc8cc','#bbc7cc','#bbc8cc','#bac8cd','#bac9ce','#bac9cf','#b9cad0','#b9cbd0','#b9cad0','#b8ccd2','#b8cbd2','#b7ccd4','#b7cdd4','#b7cdd5','#b6ced5','#b6ced7','#b6ced7','#b5d0d8','#b5d0d8','#b4d0da','#b4d0da','#b3d1dc','#b3d2dc','#b3d2dd','#b2d3dd','#b1d4df','#b1d4df','#b0d5e0','#b0d4e0','#b0d5e2','#afd5e2','#afd6e3','#aed6e4','#aed7e4','#aed7e5','#add8e6'])
			    .domain([min+1*d,min+2*d,min+3*d,min+4*d,min+5*d,min+6*d,min+7*d,min+8*d,min+9*d,min+10*d,min+11*d,min+12*d,min+13*d,min+14*d,min+15*d,min+16*d,min+17*d,min+18*d,min+19*d,min+20*d,min+21*d,min+22*d,min+23*d,min+24*d,min+25*d,min+26*d,min+27*d,min+28*d,min+29*d,min+30*d,min+31*d,min+32*d,min+33*d,min+34*d,min+35*d,min+36*d,min+37*d,min+38*d,min+39*d,min+40*d,min+41*d,min+42*d,min+43*d,min+44*d,min+45*d,min+46*d,min+47*d,min+48*d,min+49*d,min+50*d,min+51*d,min+52*d,min+53*d,min+54*d,min+55*d,min+56*d,min+57*d,min+58*d,min+59*d,min+60*d,min+61*d,min+62*d,min+63*d,min+64*d,min+65*d,min+66*d,min+67*d,min+68*d,min+69*d,min+70*d,min+71*d,min+72*d,min+73*d,min+74*d,min+75*d,min+76*d,min+77*d,min+78*d,min+79*d,min+80*d,min+81*d,min+82*d,min+83*d,min+84*d,min+85*d,min+86*d,min+87*d,min+88*d,min+89*d,min+90*d,min+91*d,min+92*d,min+93*d,min+94*d,min+95*d,min+96*d,min+97*d,min+98*d,min+99*d,min+100*d])
		}

		function palette(min, max) {
    var d = (max-min)/100;
    return d3.scaleThreshold()
        .range(['#cd5c5c','#ce5f5e','#ce6160','#cf6463','#cf6665','#d06967','#d06c69','#d16e6c','#d1716e','#d27370','#d27673','#d27875','#d37a77','#d37d7a','#d47f7c','#d4827e','#d48481','#d58783','#d58985','#d58b88','#d58e8a','#d6908c','#d6938f','#d69591','#d69794','#d69a96','#d69c98','#d79e9b','#d7a19d','#d7a3a0','#d7a5a2','#d7a8a5','#d7aaa7','#d7aca9','#d7afac','#d7b1ae','#d7b3b1','#d6b6b3','#d6b8b6','#d6bab8','#d6bdbb','#d6bfbd','#d6c1c0','#d5c4c2','#d5c6c5','#d5c8c8','#d4cbca','#d4cdcd','#d4cfcf','#d3d2d2','#d2d2d3','#cfd0d2','#cdcfd1','#cacdd1','#c7cbd0','#c5cad0','#c2c8cf','#c0c6ce','#bdc5ce','#bbc3cd','#b8c1cd','#b5bfcc','#b3becb','#b0bccb','#aebaca','#abb9ca','#a8b7c9','#a6b5c8','#a3b4c8','#a0b2c7','#9eb0c6','#9bafc6','#98adc5','#96acc5','#93aac4','#90a8c3','#8ea7c3','#8ba5c2','#88a3c1','#85a2c1','#83a0c0','#809ec0','#7d9dbf','#7a9bbe','#779abe','#7498bd','#7196bc','#6e95bc','#6b93bb','#6892ba','#6590ba','#628eb9','#5f8db9','#5b8bb8','#588ab7','#5588b7','#5187b6','#4e85b5','#4a84b5','#4682b4'])
        .domain([min+1*d,min+2*d,min+3*d,min+4*d,min+5*d,min+6*d,min+7*d,min+8*d,min+9*d,min+10*d,min+11*d,min+12*d,min+13*d,min+14*d,min+15*d,min+16*d,min+17*d,min+18*d,min+19*d,min+20*d,min+21*d,min+22*d,min+23*d,min+24*d,min+25*d,min+26*d,min+27*d,min+28*d,min+29*d,min+30*d,min+31*d,min+32*d,min+33*d,min+34*d,min+35*d,min+36*d,min+37*d,min+38*d,min+39*d,min+40*d,min+41*d,min+42*d,min+43*d,min+44*d,min+45*d,min+46*d,min+47*d,min+48*d,min+49*d,min+50*d,min+51*d,min+52*d,min+53*d,min+54*d,min+55*d,min+56*d,min+57*d,min+58*d,min+59*d,min+60*d,min+61*d,min+62*d,min+63*d,min+64*d,min+65*d,min+66*d,min+67*d,min+68*d,min+69*d,min+70*d,min+71*d,min+72*d,min+73*d,min+74*d,min+75*d,min+76*d,min+77*d,min+78*d,min+79*d,min+80*d,min+81*d,min+82*d,min+83*d,min+84*d,min+85*d,min+86*d,min+87*d,min+88*d,min+89*d,min+90*d,min+91*d,min+92*d,min+93*d,min+94*d,min+95*d,min+96*d,min+97*d,min+98*d,min+99*d,min+100*d]);
		}

		const parmDict = {'ALL':'All Indices','VA':'Voice & Accountability','PS':'Political Stability & Absence of Violence/Terrorism',
			'GE':'Government Effectiveness','RQ':'Regulatory Quality','RL':'Rule of Law','CC':'Control of Corruption'}

		const trans = d3.transition().duration(750)
		
		const cbsvg = d3.select('#cbar')

		d3.select("#close").on('click',function() {
			d3.select("#modbg").transition(trans).style("display","none")
			d3.select("#modal").transition(trans).style("display","none")
		})

		d3.select("#closecap").on('click',function() {
			d3.select("#modbg").transition(trans).style("display","none")
			d3.select("#modcap").transition(trans).style("display","none")
		})

		d3.select("#modbg").on('click',function() {
			d3.select("#modbg").transition(trans).style("display","none")
			d3.select("#modal").transition(trans).style("display","none")
		})

		d3.select("#help").on('click',function() {
			d3.select("#modbg").transition(trans).style("display","block")
			d3.select("#modal").transition(trans).style("display","block")
		})

		const yearSel = d3.select("#year")
		let year = yearSel.property("value")

		const paramSel = d3.select("#param")
		let param = paramSel.property("value")

		const showConSel = d3.select("#showCon")
		let showCon = showConSel.property("value")

		yearSel.on("change",function(){
			year = d3.select(this).property("value")
			if (year == "ALL") {
				d3.select("#allparam").attr("disabled",true)
			} else {
				d3.select("#allparam").attr("disabled",null)
			}
			onUpdate(data,year,param,showCon)
		})

		paramSel.on("change",function() {
			param = d3.select(this).property("value")
			if (param == "ALL") {
				d3.select("#allyear").attr("disabled",true)
			} else {
				d3.select("#allyear").attr("disabled",null)
			}
			onUpdate(data,year,param,showCon)
		})

		showConSel.on("change",function() {
			showCon = d3.select(this).property("value")
			onUpdate(data,year,param,showCon)
		})

		var data;
		d3.text(`https://gist.githubusercontent.com/briegn1/65da9a8b0b52f38cd2da3d2b2ac31e40/raw/f95094bdb623f2dd3d54cb8ed3353d6dec95d848/Coordinates.csv`).then(function(txt) {
				data = d3.csvParse(txt)
				onUpdate(data,year,param,showCon)
				//onUpdate(data,year,param,showCon)
				year = "2017"
				yearSel.property("value",year)
				yearSel.dispatch("change")
			}
		)

		const xs = [1,3,5,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22]
		const years = ['1996','1998','2000','2002','2003','2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017']
		const vars = ["VA","PS","GE","RQ","RL","CC","VA"]

		d3.select('#downyear').on('click',function() {
			let io = years.indexOf(year)
			if (io == 0) {
				if (param == "ALL") {
					return false
				} else {
					yearSel.property("value","ALL")
					yearSel.dispatch("change")
				}
			} else if (io<0) {
				return false
			} else {
				yearSel.property("value",years[io-1])
				yearSel.dispatch("change")
			}
		})

		d3.select('#upyear').on('click',function() {
			let io = years.indexOf(year)
			if (io>17) {
				return false
			} else {
				yearSel.property("value",years[io+1])
				yearSel.dispatch("change")
			}
		})

		d3.select('#downparam').on('click',function() {
			let io = vars.indexOf(param)
			if (io == 0) {
				if (year == "ALL") {
					return false
				} else {
					paramSel.property("value","ALL")
					paramSel.dispatch("change")
				}
			} else if (io<0) {
				return false
			} else {
				paramSel.property("value",vars[io-1])
				paramSel.dispatch("change")
			}
		})

		d3.select('#upparam').on('click',function() {
			let io = vars.indexOf(param)
			if (io>4) {
				return false
			} else {
				paramSel.property("value",vars[io+1])
				paramSel.dispatch("change")
			}
		})

		function showAllYear(dt,prm) {
			let tot = 0
			let p = ""
			for (let j=0;j<years.length;j++) {
			  p = years[j]
			  if (parseFloat(dt[prm+'_'+p+'_Rank'])<0) {
			    tot++
			  }
			}
			if (tot>18) {
			  return 0
			} else {
			  return 1
			}
		}

		function showAllVars(dt,yr) {
			let tot = 0
			let p = ""
			for (let j=0;j<vars.length-1;j++) {
				p = vars[j]
				if (parseFloat(dt[p+'_'+yr+'_Rank'])<0) {
				 tot++
				}
			}
			if (tot>2) {
				return 0
			} else {
				return 1
			}
		}

		function varDev(dt,yr) {
			let allvs = []
		  let p = ""
		  for (let j=0;j<vars.length-1;j++) {
		    p = vars[j]
		    if (parseFloat(dt[p+'_'+yr+'_Rank'])>-1) {
		      allvs.push(parseFloat(dt[p+'_'+yr+'_Rank']))
		    }
		  }
		  if (allvs.length<4) {
		    return -1
		  } else {
		    return d3.deviation(allvs)
		  }
		}

		function varMean(dt,yr,prm) {
			if (prm == "ALL") {
		    let allvs = []
		    let p = ""
		    for (let j=0;j<vars.length-1;j++) {
		      p = vars[j]
		      if (parseFloat(dt[p+'_'+yr+'_Rank'])>-1) {
		        allvs.push(parseFloat(dt[p+'_'+yr+'_Rank']))
		      }
		    }
		    return d3.mean(allvs)
		  } else if (yr == "ALL") {
		    let allvs = []
		    let p = ""
		    for (let j=0;j<years.length-1;j++) {
		      p = years[j]
		      if (parseFloat(dt[prm+'_'+p+'_Rank'])>-1) {
		        allvs.push(parseFloat(dt[prm+'_'+p+'_Rank']))
		      }
		    }
		    return d3.mean(allvs)
		  } else {
		    return -1
		  }
		}

		function topBottomThree(dt,yr,prm) {
			let t3 = []
		  let b3 = []
		  if (param !== "ALL") {
		    let yearbef = parseInt(yr)-1
		    let yyr = yr
		    if (year == '1996') {return {'top3':[{'WBCountry/Territory':'','diff':''},{'WBCountry/Territory':'','diff':''},{'WBCountry/Territory':'','diff':''}],'bottom3':[{'WBCountry/Territory':'','diff':''},{'WBCountry/Territory':'','diff':''},{'WBCountry/Territory':'','diff':''}]}}
		    else if (year == 'ALL') {
		      yearbef = '1996'
		      yyr = '2017'
		    } else if (parseInt(yr)<2003) {
		      yearbef = parseInt(yr)-2
		    }

		    dt.sort(function(x,y) {
		      return d3.ascending(x[prm+'_'+yyr+'_Rank']-x[prm+'_'+yearbef+'_Rank'],y[prm+'_'+yyr+'_Rank']-y[prm+'_'+yearbef+'_Rank'])
		    })

		    let k = dt.length-1
		    while (t3.length<3) {
		      let test = dt[k]
		      if (test[prm+'_'+yyr+'_Rank']>=0 && test[prm+'_'+yearbef+'_Rank']>=0) {
		        test.diff = test[prm+'_'+yyr+'_Rank']-test[prm+'_'+yearbef+'_Rank']
		        t3.push(test)
		      }
		      k = k-1
		    }

		    k = 0
		    while (b3.length<3) {
		      let test = dt[k]
		      if (test[prm+'_'+yyr+'_Rank']>=0 && test[prm+'_'+yearbef+'_Rank']>=0) {
		        test.diff = test[prm+'_'+yyr+'_Rank']-test[prm+'_'+yearbef+'_Rank']
		        b3.push(test)
		      }
		      k = k+1
		    }
		  } else {
		    dt.sort(function(x,y) {
		      return d3.ascending(varDev(x,yr),varDev(y,yr))
		    })
		    
		    let k = dt.length-1
		    while (t3.length<3) {
		      let test = dt[k]
		      test.diff = varDev(test,yr)
		      t3.push(test)
		      k = k-1
		    }
		    
		    k = 0
		    while (b3.length<3) {
		      let test = dt[k]
		      test.diff = varDev(test,yr)
		      if (test.diff>0) {
		        b3.push(test)
		      }
		      k = k+1
		    }
		  }
		  return {'top3':t3,'bottom3':b3}
		}

		const xhexmult = [0,Math.sqrt(3)/2,Math.sqrt(3)/2,0,-Math.sqrt(3)/2,-Math.sqrt(3)/2,0]
		const yhexmult = [-1,-0.5,0.5,1,0.5,-0.5,-1]

		const width = 1080
		const height = 810
		const cellSpacing = 2
		const cellSize = 26
		const svg = d3.select('#grid')
		const infosvg = d3.select('#ctyGraphic')

		let lookAtTxt = parmDict[param]+' for '
		if (year !== 'ALL') {lookAtTxt = lookAtTxt+year} else {lookAtTxt = lookAtTxt+'1996 to 2017'}
		svg.append('text')
			.attr('id','lookAt')
			.attr('class','subtitle')
			.attr('fill','black')
			.attr('x',540)
			.attr('y',25)
			.attr('text-anchor','middle')
			.attr('alignment-baseline','central')
			.text(lookAtTxt)

		const color = palette(0,100)

		const crange = [...Array(151).keys()]
		/*svg.append('rect')
			.attr('x',0)
			.attr('y',0)
			.attr('width',180)
			.attr('height',80)
			.attr('fill','none')
			.attr('stroke','black')
			.attr('stroke-width','1px')*/
		svg.append('text')
			.attr('id','cbarttl')
			.attr('fill','black')
			.attr('x',5)
			.attr('y',15)
			.text('Color by Percentile')
  	cbsvg.selectAll(".cbrect").data(crange).enter().append("rect")
  		.attr('class','cbrect')
	    .attr('x',function(d){return d+5})
	    .attr('y',25)
	    .attr('width',1)
	    .attr('height',30)
	    .attr('fill',function(d) {return color(d/1.5)})
		cbsvg.selectAll(".cbtext").data(crange).enter().append("text")
	  	.attr('class','cbtext')
	    .attr('x',function(d) {return d+5})
	    .attr('y',60)
	    .attr('font-family','sans-serif')
	    .attr('font-size','12px')
	    .attr('fill','black')
	    .attr('transform',function(d) {return 'rotate(45,'+d+',60)'})
	    .text(function(d) {if (d%75 == 0) {return Math.round(d/1.5)} else {return ''}})

		const line = d3.line()
			.x(function(d) {
			  return d.x
			})
			.y(function(d) {
			  return d.y
			})

		const hex = d3.line()
			.x(function(d) {
			  return d.x+13
			})
			.y(function(d) {
			  return d.y+18
			})

		const bigline = d3.line()
			.x(function(d) {
			  return (d.x)*7+15
			})
			.y(function(d) {
			  return (d.y-4)*7
			})

		const bighex = d3.line()
			.x(function(d) {
			  return (d.x)*16+100
			})
			.y(function(d) {
			  return (d.y)*16+100
			})

		const bigarea = d3.area()
			.x(function(d) {
			  return (d.x)*7+15
			})
			.y0(function(d) {
			  return (d.y0-4)*7
			})
			.y1(function(d) {
			  return (d.y1-4)*7
			})

		let selCont = null

		function onUpdate(dt,yr,prm,sc) {
			dt.map(function(d){
		    let points = []
		    let val = 0
		    let inter = []
		    if (prm !== "ALL") {
		      let yr = ''
		      for (let j=0;j<xs.length;j++) {
		        yr = years[j]
		        val = parseFloat(d[prm+'_'+yr+'_Rank'])
		        if (val>0) {
		          points.push({'x':xs[j],'y':24-val/10.})
		          inter.push({'x':xs[j],'y0':24-parseFloat(d[prm+'_'+yr+'_Upper'])/10.,'y1':24-parseFloat(d[prm+'_'+yr+'_Lower'])/10.})
		        }
		      }
		    } else {
		      inter = {'upper':[],'lower':[]}
		      let vr = ''
		      let xm = 0
		      let ym = 0
		      for (let j=0;j<vars.length;j++) {
		        vr = vars[j]
		        xm = xhexmult[j]
		        ym = yhexmult[j]
		        val = parseFloat(d[vr+'_'+yr+'_Rank'])
		        if (val>0) {
		          points.push({'x':0.5*xm*val/10.,'y':0.5*ym*val/10.})
		          inter.upper.push({'x':0.5*xm*parseFloat(d[vr+'_'+yr+'_Upper'])/10.,'y':0.5*ym*parseFloat(d[vr+'_'+yr+'_Upper'])/10.})
		          inter.lower.push({'x':0.5*xm*parseFloat(d[vr+'_'+yr+'_Lower'])/10.,'y':0.5*ym*parseFloat(d[vr+'_'+yr+'_Lower'])/10.})
		        }
		      }
		    }
		    d.points = points
		    d.inter = inter
		  })

		  let lookAtTxt = parmDict[prm]+' for '
			if (yr !== 'ALL') {lookAtTxt = lookAtTxt+yr} else {lookAtTxt = lookAtTxt+'1996 to 2017'}
			d3.select('#lookAt').text(lookAtTxt)

		  if (selCont !== null) {
		  	d3.selectAll('.lne').remove()
		  	scdt = null
	  		for (let y of dt) {
	  			if (y.WBCode == selCont) {
	  				scdt = y
	  			}
	  		}
		  	if (yr == 'ALL') {
		  		let vm = varMean(scdt,yr,prm)
		  		d3.select('#value').transition(trans).text(prm+' Mean for 1996-2017: '+vm.toFixed(2))
		  		yearLine(scdt.points,scdt.inter,yr,prm)
		  	} else if (prm == 'ALL') {
		  		let vm = varMean(scdt,yr,prm)
		  		d3.select('#value').transition(trans).text('All Variables Mean for '+yr+': '+vm.toFixed(2))
		  		parmHex(scdt.points,scdt.inter,yr,prm)
		  	} else {
		  		d3.select('#value').transition(trans).text(yr+' '+prm+': '+scdt[prm+'_'+yr+'_Lower']+' - '+scdt[prm+'_'+yr+'_Upper'])
		  	}
		  }

		  let cell = svg.selectAll('g').data(dt,function(d) {return d.WBCode})

		  let enterCell = cell.enter().append("g")
				.attr("class", "cells")

			enterCell.append("rect")
				.attr('class','conts')
		    .attr('x',-1)
		    .attr('y',-1)
		    .attr('width',cellSize+2)
		    .attr('height',cellSize+2)

			enterCell.append("rect")
		  	.attr('class','foreground')
		    .attr('width',cellSize)
		    .attr('height',cellSize)

		  enterCell.append("text")
		    .attr('x',1)
		    .attr('y',9)
		    .attr('font-family','sans-serif')
		    .attr('font-size','10px')
		    .attr('fill','black')
		    .attr('cursor','default')

		  enterCell.append("path")
	      .attr('stroke','black')
	      .attr('stroke-width',1)

		  enterCell.attr('transform',function(d,i) {return "translate(" + (parseInt(d.XBTrans-1)*cellSpacing+parseInt(d.XBTrans-1)*cellSize+21) + "," + (parseInt(d.YBTrans)*cellSpacing+parseInt(d.YBTrans)*cellSize+21) + ")"})

			enterCell.select("text")
				.text(function(d,i) {return d.WBCode})

		  cell.merge(enterCell)
		  		.select("path")
		  		.transition(trans)
		      .attr('opacity',function() {
		      	if (yr == "ALL" || prm == "ALL") {
		      		return 1
		      	} else {
		      		return 0
		      	}
		      })

		  cell.merge(enterCell)
		  	.select('rect.conts')
		  	.transition(trans)	  	
		    .attr('fill',function(d) {
		      let cont = 'black'
		      switch(parseInt(d.Continent)) {
		        case 1:
		          cont = 'red'
		          break
		        case 2:
		          cont = 'orange'
		          break
		        case 3:
		          cont = 'yellow'
		          break
		        case 4:
		          cont = 'green'
		          break
		        case 5:
		          cont = 'blue'
		          break
		        case 6:
		          cont = 'fuchsia'
		          break
		        case 7:
		          cont = 'purple'
		          break
		      }
		      return cont
		    })
		    .attr('opacity',function(d) {
		      if (sc == 'On') {
		        if (yr !== 'ALL') {
		          if (prm !== 'ALL') {
		            if (parseFloat(d[prm+'_'+yr+'_Rank'])>0) {
		              return 0.5
		            } else {
		              return 0
		            }
		          } else {
		            return showAllVars(d,yr)*0.5
		          }
		        } else {
		          return showAllYear(d,prm)*0.5
		        }
		      } else {return 0}
		    })		    

		  if (yr == "ALL" || prm == "ALL") {

		  	cell.merge(enterCell)
		  		.select("rect.foreground")
		  		.transition(trans)
		    	.attr('fill',function(d) {return color(varMean(d,yr,prm))})
		    
		    if (yr == "ALL") {
		      cell.merge(enterCell).select("path").transition(trans).attr('d',function(d) {return line(d.points)}).attr('fill','none')
		      cell.merge(enterCell).select("rect.foreground").transition(trans).attr('opacity',function(d) {return showAllYear(d,prm)})
		      cell.merge(enterCell).select("text").transition(trans).attr('opacity',function(d) {return showAllYear(d,prm)})
		    } else {
		      cell.merge(enterCell).select("path").transition(trans).attr('d',function(d) {
		        if (d.points.length>4) {
		          return hex(d.points)
		        } else {return false}
		      }).attr('fill','black')
		      cell.merge(enterCell).select("rect.foreground").transition(trans).attr('opacity',function(d) {return showAllVars(d,yr)})
		      cell.merge(enterCell).select("text").transition(trans).attr('opacity',function(d) {return showAllVars(d,yr)})
		    }

		    cell.on('mouseover',function(){d3.select(this).select('.foreground').attr('fill','yellow')})
		      .on('mouseout',function(d,i) {d3.select(this).select('.foreground').attr('fill',function(d) {return color(varMean(d,yr,prm))})})
		      .on('click',function(d,i) {
		      	selCont = d.WBCode
		        d3.select('#country').text(d['WBCountry/Territory'])
		        const dpts = d.points
		        const dinter = d.inter
		        let vm = varMean(d,yr,prm)
		        if (yr == "ALL") {
		        	d3.select('#value').transition(trans).text(prm+' Mean for 1996-2017: '+vm.toFixed(2))
		        	yearLine(dpts,dinter,yr,prm)
		        } else {
		        	d3.select('#value').transition(trans).text('All Variables Mean for '+yr+': '+vm.toFixed(2))
		        	parmHex(dpts,dinter,yr,prm)
		        }
		      })
		    cell.merge(enterCell)
		  } else {
		    cell.merge(enterCell).select("rect.foreground").transition(trans).attr('fill',function(d,i) {return color(parseFloat(d[prm+'_'+yr+'_Rank']))})
		    	.attr('opacity',function(d,i) {return (parseFloat(d[prm+'_'+yr+'_Rank'])>0 ? 1 : 0)})
		    
		    cell.merge(enterCell).select("text").transition(trans).attr('opacity',function(d,i) {return (parseFloat(d[prm+'_'+yr+'_Rank'])>0 ? 1 : 0)})
		    
		    cell.on('mouseover',function(){d3.select(this).select('.foreground').attr('fill','yellow')})
		      .on('mouseout',function(d,i) {d3.select(this).select('.foreground').attr('fill',color(parseFloat(d[prm+'_'+yr+'_Rank'])))})
		      .on('click',function(d,i) {
		        if (parseFloat(d[prm+'_'+yr+'_Rank'])>0) {
		        	selCont = d.WBCode
		          d3.select('#country').transition(trans).text(d['WBCountry/Territory'])
		          d3.select('#value').transition(trans).text(yr+' '+prm+': '+d[prm+'_'+yr+'_Lower']+' - '+d[prm+'_'+yr+'_Upper'])
		        } else {
		          return false
		        }
		      })

		    cell.merge(enterCell)
		  }
		  cell.exit().remove()

		  d3.selectAll('.tb3txt').remove()
		  if (prm != 'ALL' && yr != '1996') {
		  	if (yr == 'ALL') {
		  		d3.select('#tbrange').text('1996 to 2017')
		  	} else {
		  		let yearbef = parseInt(yr)-1
		  		d3.select('#tbrange').text(yearbef+' to '+yr)
		  	}
			  const tb3 = topBottomThree(dt,yr,prm)
			  const t3 = tb3.top3
			  const b3 = tb3.bottom3
			  let q = 1
			  while (q<4) {
			  	if (captxt[t3[q-1]['WBCountry/Territory']]) {
			  		d3.select('#t3-'+q).text('').append('u').attr('class','tb3txt').attr('cty',t3[q-1]['WBCountry/Territory']).text(t3[q-1]['WBCountry/Territory']+': '+t3[q-1].diff.toFixed(2))
			  	} else {
			  		d3.select('#t3-'+q).text(t3[q-1]['WBCountry/Territory']+': '+t3[q-1].diff.toFixed(2))
			  	}
			  	if (captxt[b3[q-1]['WBCountry/Territory']]) {
			  		d3.select('#b3-'+q).text('').append('u').attr('class','tb3txt').attr('cty',b3[q-1]['WBCountry/Territory']).text(b3[q-1]['WBCountry/Territory']+': '+b3[q-1].diff.toFixed(2))
			  	} else {
			  		d3.select('#b3-'+q).text(b3[q-1]['WBCountry/Territory']+': '+b3[q-1].diff.toFixed(2))
			  	}
			  	q++
			  }
			} else {
				d3.select('#tbrange').text('')
				let q = 1
				while (q<4) {
			  	d3.select('#t3-'+q).text('')
			  	d3.select('#b3-'+q).text('')
			  	q++
			  }
			}
			d3.selectAll('.tb3txt').attr('title','Click for More Information').on('click',function() {
				var thisCon = d3.select(this).attr('cty')
				d3.select("#captitle").text(thisCon)
				d3.select("#captxt").text(captxt[thisCon])
				d3.select("#modbg").transition(trans).style("display","block")
				d3.select("#modcap").transition(trans).style("display","block")
			})
		}

		function yearLine(dpts,dinter,yr,prm) {
			if (!d3.selectAll('.lne').empty()) {
				d3.selectAll('.lne').remove()
			}
			infosvg.append("path")
      	.attr('class','lne')
      	.attr('stroke-width',0)
      	.attr('fill','lightgrey')
      	.attr('d',function() {return bigarea(dinter)})	

      infosvg.append("path")
        .attr('id','lne')
        .attr('class','lne')
        .attr('stroke','black')
        .attr('fill','none')
        .attr('stroke-width',1).attr('d',function() {return bigline(dpts)})

      infosvg.append("text")
      	.attr('class','lne')
        .attr('x',0)
        .attr('y',30)
        .attr('font-family','Source Sans Pro, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif')
        .attr('font-size','12px')
        .attr('fill','black')
        .text(prm+' over time')

      infosvg.append("text")
      	.attr('class','lne')
        .attr('x',0)
        .attr('y',45)
        .attr('font-family','Source Sans Pro, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('90% confidence interval in gray')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',0)
        .attr('y',(20-10)*7)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('100')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',6.5)
        .attr('y',(20-5)*7)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('50')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',13)
        .attr('y',20*7+2)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('0')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',22)
        .attr('y',147)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(45,22,147)')
        .text('1996')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',70)
        .attr('y',147)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(45,70,147)')
        .text('2003')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',118)
        .attr('y',147)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(45,118,147)')
        .text('2010')

      infosvg.append("text")
        .attr('class','lne')
        .attr('x',166)
        .attr('y',147)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(45,166,147)')
        .text('2017')
      
      infosvg.append("path")
        .attr('class','lne')
        .attr('stroke','grey')
        .attr('fill','none')
        .attr('stroke-width',1)
        .attr('d','M 168 140 L 23 140 L 23 66')
		}

		function parmHex(dpts,dinter,yr,prm) {
			if (!d3.selectAll('.lne').empty()) {
				d3.selectAll('.lne').remove()
			}
			infosvg.append("path")
        .attr('class','lne')
        .attr('stroke','black')
        .attr('fill','lightgrey')
        .attr('stroke-width',0).attr('d',function() {return bighex(dinter.upper)})
      
      infosvg.append("path")
        .attr('class','lne')
        .attr('stroke','black')
        //.attr('fill','#DBB394')
        .attr('fill','white')
        .attr('stroke-width',0).attr('d',function() {return bighex(dinter.lower)})
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',92)
        .attr('y',14)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('VA')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',169)
        .attr('y',50)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(60,169,50)')
        .text('PS')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',22)
        .attr('y',64)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(-60,22,64)')
        .text('CC')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',92)
        .attr('y',194)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .text('RQ')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',17)
        .attr('y',141)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(60,17,141)')
        .text('RL')
      
      infosvg.append("text")
        .attr('class','lne')
        .attr('x',175)
        .attr('y',153)
        .attr('font-family','sans-serif')
        .attr('font-size','10px')
        .attr('fill','black')
        .attr('transform','rotate(-60,175,153)')
        .text('GE')
      
      infosvg.append("path")
        .attr('class','lne')
        .attr('stroke','grey')
        .attr('fill','none')
        .attr('stroke-width',1)
        .attr('d','M 100 100 L 100 180 M 100 100 L 100 20 M 100 100 L 169.28 140 M 100 100 L 169.28 60 M 100 100 L 30.72 140 M 100 100 L 30.72 60')
      
      infosvg.append("circle")
        .attr('class','lne')
        .attr('cx',100)
        .attr('cy',100)
        .attr('r',80)
        .attr('fill','none')
        .attr('stroke','grey')
        .attr('stroke-width',1)
      
      infosvg.append("path")
        .attr('id','lne')
        .attr('class','lne')
        .attr('stroke','black')
        .attr('fill','none')
        .attr('stroke-width',1).attr('d',function() {return bighex(dpts)})
    }

	</script>
</body>
</html>
